name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  shellcheck:
    name: ShellCheck Linting
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: './cmd ./lib ./providers ./modules'
        severity: warning
        ignore_paths: tests
  
  bats-tests:
    name: Bats Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        os: [ubuntu-latest]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Bats
      run: |
        sudo apt-get update
        sudo apt-get install -y bats
    
    - name: Run Bats tests
      run: |
        bats tests/bats/cli.bats
        bats tests/bats/health.bats
        bats tests/bats/update-dryrun.bats
  
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Test CLI help
      run: ./cmd/ubopt --help
    
    - name: Test health check
      run: ./cmd/ubopt health
    
    - name: Test health JSON
      run: ./cmd/ubopt health --json
    
    - name: Test update check (dry-run)
      run: ./cmd/ubopt update check --dry-run
    
    - name: Test update apply (dry-run)
      run: ./cmd/ubopt update apply --dry-run
    
    - name: Test hardening (dry-run)
      run: sudo ./cmd/ubopt hardening apply --dry-run || true
    
    - name: Test benchmark
      run: ./cmd/ubopt benchmark
  
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for TODO/FIXME
      run: |
        if grep -r "FIXME\|TODO" cmd/ lib/ providers/ modules/ 2>/dev/null; then
          echo "Found TODO/FIXME comments"
          exit 0  # Warning only
        fi
    
    - name: Check file permissions
      run: |
        # Verify all .sh files are executable
        find cmd lib providers modules -type f -name "*.sh" ! -executable -print
        # Verify ubopt is executable
        test -x cmd/ubopt
    
    - name: Verify no hardcoded secrets
      run: |
        if grep -r -i "password\|secret\|api[_-]key" cmd/ lib/ providers/ modules/ 2>/dev/null | grep -v "# " | grep -v "PasswordAuthentication"; then
          echo "⚠️  Potential hardcoded secrets found"
          exit 1
        fi
  
  package-deb:
    name: Build Debian Package
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install packaging tools
      run: |
        sudo apt-get update
        sudo apt-get install -y devscripts debhelper lintian build-essential
    
    - name: Build .deb package
      run: |
        debuild -us -uc
    
    - name: Run lintian (fail on errors only)
      run: |
        # Move .deb artifacts to parent directory as debuild does
        # Run lintian with E (error) severity only
        cd ..
        lintian --fail-on error --suppress-tags file-references-package-build-path ubopt_*.deb || exit 1
        # Show full info for visibility (warnings/info don't fail)
        lintian --display-info --display-experimental ubopt_*.deb || true
    
    - name: Upload .deb artifacts
      uses: actions/upload-artifact@v4
      with:
        name: debian-package
        path: |
          ../*.deb
          ../*.dsc
          ../*.changes
          ../*.buildinfo
        retention-days: 30
  
  container-tests:
    name: Container Tests (${{ matrix.distro }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: debian:12
            pkg_manager: apt-get
            install_cmd: apt-get update && apt-get install -y
          - distro: fedora:41
            pkg_manager: dnf
            install_cmd: dnf install -y
          - distro: archlinux:latest
            pkg_manager: pacman
            install_cmd: pacman -Sy --noconfirm
    
    container:
      image: ${{ matrix.distro }}
    
    steps:
    - name: Install base dependencies
      run: |
        ${{ matrix.install_cmd }} bash coreutils grep gawk
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install shellcheck
      run: |
        if [ "${{ matrix.pkg_manager }}" = "apt-get" ]; then
          apt-get update && apt-get install -y shellcheck
        elif [ "${{ matrix.pkg_manager }}" = "dnf" ]; then
          dnf install -y ShellCheck
        elif [ "${{ matrix.pkg_manager }}" = "pacman" ]; then
          pacman -Sy --noconfirm shellcheck
        fi
    
    - name: Install bats
      run: |
        if [ "${{ matrix.pkg_manager }}" = "apt-get" ]; then
          apt-get install -y bats
        elif [ "${{ matrix.pkg_manager }}" = "dnf" ]; then
          dnf install -y bats
        elif [ "${{ matrix.pkg_manager }}" = "pacman" ]; then
          pacman -Sy --noconfirm bats
        fi
    
    - name: Run shellcheck
      run: |
        shellcheck cmd/ubopt lib/*.sh modules/*.sh providers/*.sh exporters/*.sh
    
    - name: Run bats tests
      run: |
        bats tests/bats/cli.bats
        bats tests/bats/health.bats
        bats tests/bats/update-dryrun.bats
