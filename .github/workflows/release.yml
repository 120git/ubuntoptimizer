name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Install packaging tools
      run: |
        sudo apt-get update
        sudo apt-get install -y devscripts debhelper lintian build-essential
    
    - name: Build .deb package
      run: |
        debuild -us -uc
    
    - name: Move .deb artifacts to dist
      run: |
        mkdir -p dist
        mv ../*.deb ../*.dsc ../*.changes ../*.buildinfo dist/ 2>/dev/null || true
    
    - name: Create release tarball
      run: |
        tar -czf dist/ubopt-${{ steps.get_version.outputs.VERSION }}.tar.gz \
          cmd/ lib/ providers/ modules/ exporters/ etc/ systemd/ packaging/ debian/ docs/ tests/ \
          Makefile README.md LICENSE
    
    - name: Install RPM build tools
      run: |
        sudo apt-get install -y rpm rpmbuild
    
    - name: Build RPM package in Fedora container
      run: |
        # Use Docker to build RPM in Fedora environment
        docker pull fedora:41
        docker run --rm -v $(pwd):/workspace -w /workspace fedora:41 bash -c "
          dnf install -y rpm-build rpmdevtools tar gzip &&
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS} &&
          tar -czf rpmbuild/SOURCES/ubopt-${{ steps.get_version.outputs.VERSION }}.tar.gz \
            --transform 's,^,ubopt-${{ steps.get_version.outputs.VERSION }}/,' \
            cmd/ lib/ providers/ modules/ exporters/ etc/ systemd/ packaging/ docs/ tests/ \
            Makefile README.md LICENSE &&
          rpmbuild --define '_topdir $(pwd)/rpmbuild' -ba packaging/rpm/ubopt.spec &&
          cp rpmbuild/RPMS/noarch/*.rpm dist/ 2>/dev/null || true &&
          cp rpmbuild/SRPMS/*.rpm dist/ 2>/dev/null || true
        "
    
    - name: Install Syft for SBOM generation
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
    
    - name: Generate SBOM for repository
      run: |
        syft dir:. -o spdx-json=dist/sbom-dir-${{ github.ref_name }}.spdx.json
    
    - name: Generate SBOM for .deb package
      run: |
        DEB_FILE=$(ls dist/*.deb | head -n1)
        if [ -f "$DEB_FILE" ]; then
          syft file:"$DEB_FILE" -o spdx-json=dist/sbom-deb-${{ github.ref_name }}.spdx.json
        fi
    
    - name: Generate SBOM for RPM package
      run: |
        RPM_FILE=$(ls dist/*.noarch.rpm 2>/dev/null | head -n1)
        if [ -f "$RPM_FILE" ]; then
          syft packages file:"$RPM_FILE" -o spdx-json=dist/sbom-rpm-${{ github.ref_name }}.spdx.json
        fi
    
    - name: Create provenance JSON
      run: |
        cat > dist/provenance-${{ github.ref_name }}.json <<EOF
        {
          "version": "1.0",
          "build": {
            "ref": "${{ github.ref }}",
            "sha": "${{ github.sha }}",
            "runner": "${{ runner.os }}-${{ runner.arch }}",
            "workflow": "${{ github.workflow }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "artifacts": {
              "tarball": "ubopt-${{ steps.get_version.outputs.VERSION }}.tar.gz",
              "debian": "$(basename $(ls dist/*.deb 2>/dev/null | head -n1) 2>/dev/null || echo 'none'),"
              "rpm": "$(basename $(ls dist/*.noarch.rpm 2>/dev/null | head -n1) 2>/dev/null || echo 'none')"
            }
          },
          "sbom": {
            "directory": "sbom-dir-${{ github.ref_name }}.spdx.json",
            "debian": "sbom-deb-${{ github.ref_name }}.spdx.json",
            "rpm": "sbom-rpm-${{ github.ref_name }}.spdx.json"
          },
          "signatures": {
            "algorithm": "cosign",
            "keyless": false
          }
        }
        EOF
        cat dist/provenance-${{ github.ref_name }}.json
    
    - name: Install Cosign for signing
      uses: sigstore/cosign-installer@v3
    
    - name: Sign all artifacts with Cosign
      env:
        COSIGN_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
      run: |
        cd dist
        # Sign each artifact and generate .sig and .pem
        for file in *.tar.gz *.deb *.rpm *.spdx.json provenance-*.json 2>/dev/null; do
          if [ -f "$file" ]; then
            echo "Signing: $file"
            # Sign with private key from secrets
            echo "$COSIGN_KEY" > /tmp/cosign.key
            cosign sign-blob --key /tmp/cosign.key --yes "$file" --output-signature "${file}.sig"
            # Generate certificate (using public key derivation)
            cosign public-key --key /tmp/cosign.key > "${file}.pem" || true
            rm -f /tmp/cosign.key
          fi
        done
    
    - name: Generate checksums
      working-directory: dist
      run: |
        sha256sum *.tar.gz *.deb *.spdx.json provenance-*.json 2>/dev/null > checksums.txt || true
        cat checksums.txt
    
    - name: Compute artifact subjects (hashes for SLSA)
      id: hash
      working-directory: dist
      run: |
        # Create base64-encoded list of artifact hashes for SLSA
        SUBJECTS=""
        for file in *.tar.gz *.deb *.rpm; do
          if [ -f "$file" ]; then
            HASH=$(sha256sum "$file" | awk '{print $1}')
            NAME=$(basename "$file")
            SUBJECTS="${SUBJECTS}${NAME}:${HASH},"
          fi
        done
        # Remove trailing comma and base64 encode
        SUBJECTS="${SUBJECTS%,}"
        SUBJECTS_B64=$(echo -n "$SUBJECTS" | base64 -w 0)
        echo "hashes=${SUBJECTS_B64}" >> $GITHUB_OUTPUT
        echo "Generated SLSA subjects: $SUBJECTS"
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.get_version.outputs.VERSION }}
        body: |
          ## Cool Llama Linux Optimizer v${{ steps.get_version.outputs.VERSION }}
          
          ### Installation from tarball
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ubopt-${{ steps.get_version.outputs.VERSION }}.tar.gz
          tar -xzf ubopt-${{ steps.get_version.outputs.VERSION }}.tar.gz
          cd ubopt-${{ steps.get_version.outputs.VERSION }}
          sudo make install
          ```
          
          ### Installation from .deb (Debian/Ubuntu)
          ```bash
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ubopt_*.deb
          sudo dpkg -i ubopt_*.deb
          sudo apt-get install -f  # Fix dependencies if needed
          ```
         
           ### Installation from .rpm (Fedora/RHEL/CentOS)
           ```bash
           wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/ubopt-*.noarch.rpm
           sudo dnf install ./ubopt-*.noarch.rpm
           ```
          
          ### Verification
          ```bash
          # Verify checksums
          sha256sum -c checksums.txt
          
          # Verify signatures (requires cosign with public key)
          cosign verify-blob \
            --key ubopt-${{ steps.get_version.outputs.VERSION }}.tar.gz.pem \
            --signature ubopt-${{ steps.get_version.outputs.VERSION }}.tar.gz.sig \
            ubopt-${{ steps.get_version.outputs.VERSION }}.tar.gz
          ```
          
          ### Security & Supply Chain
           - **SBOM (Directory)**: `sbom-dir-${{ github.ref_name }}.spdx.json`  
           - **SBOM (Debian Package)**: `sbom-deb-${{ github.ref_name }}.spdx.json`  
           - **SBOM (RPM Package)**: `sbom-rpm-${{ github.ref_name }}.spdx.json`
          - **Provenance**: `provenance-${{ github.ref_name }}.json`
          - **Signatures**: All artifacts signed with Cosign (*.sig files)
          - **Certificates**: Public keys available (*.pem files)
          
          ### What's Changed
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
        files: |
          dist/*.tar.gz
          dist/*.deb
           dist/*.rpm
          dist/*.dsc
          dist/*.changes
          dist/*.buildinfo
          dist/checksums.txt
          dist/*.sig
          dist/*.pem
          dist/sbom-*.spdx.json
          dist/provenance-*.json
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
